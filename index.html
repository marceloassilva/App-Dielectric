<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Dados - Conectado ao Node.js</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 40px; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 100%; max-width: 550px; }
        .hidden { display: none; }

        h2, h3 { color: #333; }
        .input-group { margin-bottom: 15px; text-align: left; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }

        button { width: 100%; padding: 12px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-admin { background: #28a745; color: white; margin-top: 10px; }
        .btn-admin:hover { background: #218838; }
        .btn-danger { background: transparent; color: #dc3545; border: 1px solid #dc3545; margin-top: 25px; }
        .btn-danger:hover { background: #dc3545; color: white; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: left; }
        th { background: #f8f9fa; color: #666; }
        .admin-section { border-top: 2px solid #eee; margin-top: 30px; padding-top: 20px; }
        .status-msg { font-size: 0.9rem; color: #666; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <div id="login-screen">
            <h2>Login do Sistema</h2>
            <div class="input-group">
                <label>UsuÃ¡rio</label>
                <input type="text" id="user-input" placeholder="Ex: admin">
            </div>
            <div class="input-group">
                <label>Senha</label>
                <input type="password" id="pass-input" placeholder="Ex: 123">
            </div>
            <button class="btn-primary" onclick="tentarLogin()">Acessar Sistema</button>
        </div>

        <div id="app-screen" class="hidden">
            <h2 id="welcome-text">Bem-vindo</h2>

            <div class="user-section">
                <h3>ðŸ“Š MÃ³dulo de Tratamento</h3>
                <p class="status-msg">Conectado ao servidor de dados: <b>Ativo</b></p>
                <button class="btn-primary" onclick="alert('Funcionalidade de tratamento em breve!')">Processar Novos Dados</button>
            </div>

            <div id="admin-module" class="admin-section hidden">
                <h3>ðŸ›  Controle de UsuÃ¡rios (Admin)</h3>
                <div class="input-group">
                    <input type="text" id="new-user-name" placeholder="Nome do novo usuÃ¡rio">
                    <select id="new-user-role">
                        <option value="user">Operador (User)</option>
                        <option value="admin">Administrador</option>
                    </select>
                    <button class="btn-admin" onclick="cadastrarUsuario()">âž• Salvar Novo UsuÃ¡rio</button>
                </div>

                <h4>Lista de Acessos</h4>
                <table id="user-table">
                    <thead>
                        <tr><th>UsuÃ¡rio</th><th>Perfil</th></tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>

            <button class="btn-danger" onclick="logout()">Encerrar SessÃ£o</button>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost:3000";

        // 1. TENTAR LOGIN NO SERVIDOR
        async function tentarLogin() {
            const user = document.getElementById('user-input').value;
            const pass = document.getElementById('pass-input').value;

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user, pass })
                });

                const dados = await response.json();

                if (dados.sucesso) {
                    abrirApp(user, dados.cargo === 'admin');
                } else {
                    alert(dados.mensagem);
                }
            } catch (err) {
                alert("Erro ao conectar ao servidor Node.js. Ele estÃ¡ rodando?");
            }
        }

        // 2. CONFIGURAR VISUALIZAÃ‡ÃƒO
        function abrirApp(nome, isAdmin) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('welcome-text').innerText = "OlÃ¡, " + nome;

            if (isAdmin) {
                document.getElementById('admin-module').classList.remove('hidden');
                atualizarTabela(); // Carrega lista de usuÃ¡rios se for admin
            }
        }

        // 3. CADASTRAR NO BANCO (VIA NODE)
        async function cadastrarUsuario() {
            const nome = document.getElementById('new-user-name').value;
            const cargo = document.getElementById('new-user-role').value;
            const senha = "123"; // Senha padrÃ£o fixa para o teste

            if (!nome) return alert("Preencha o nome!");

            try {
                const response = await fetch(`${API_URL}/usuarios`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome, senha, cargo })
                });

                if (response.ok) {
                    alert(`UsuÃ¡rio ${nome} cadastrado com sucesso!`);
                    document.getElementById('new-user-name').value = "";
                    atualizarTabela();
                }
            } catch (err) {
                alert("Erro ao salvar usuÃ¡rio.");
            }
        }

        // 4. BUSCAR USUÃRIOS DO SERVIDOR
        async function atualizarTabela() {
            try {
                const response = await fetch(`${API_URL}/usuarios`);
                const lista = await response.json();

                const corpoTabela = document.querySelector('#user-table tbody');
                corpoTabela.innerHTML = "";

                lista.forEach(u => {
                    const linha = corpoTabela.insertRow();
                    linha.innerHTML = `<td>${u.nome}</td><td><b>${u.cargo.toUpperCase()}</b></td>`;
                });
            } catch (err) {
                console.error("Erro ao listar usuÃ¡rios:", err);
            }
        }

        function logout() {
            location.reload();
        }
    </script>
</body>
</html>
