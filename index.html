<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Dados - ProduÃ§Ã£o</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 40px; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 100%; max-width: 550px; text-align: center; }
        .hidden { display: none; }
        h2, h3 { color: #333; }
        .input-group { margin-bottom: 15px; text-align: left; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.3s; margin-top: 10px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-admin { background: #28a745; color: white; }
        .btn-danger { background: transparent; color: #dc3545; border: 1px solid #dc3545; margin-top: 25px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: left; }
        th { background: #f8f9fa; }
        .admin-section { border-top: 2px solid #eee; margin-top: 30px; padding-top: 20px; }
        .loading { color: #666; font-style: italic; }
    </style>
</head>
<body>

    <div class="card">
        <div id="login-screen">
            <h2>Login do Sistema</h2>
            <div class="input-group">
                <label>UsuÃ¡rio</label>
                <input type="text" id="user-input" placeholder="Ex: admin">
            </div>
            <div class="input-group">
                <label>Senha</label>
                <input type="password" id="pass-input" placeholder="Sua senha">
            </div>
            <button class="btn-primary" id="btn-entrar" onclick="tentarLogin()">Acessar Sistema</button>
            <p id="msg-status" class="loading hidden">Conectando ao servidor...</p>
        </div>

        <div id="app-screen" class="hidden">
            <h2 id="welcome-text">Bem-vindo</h2>

            <div class="user-section">
                <h3>ðŸ“Š MÃ³dulo de Tratamento</h3>
                <button class="btn-primary">Processar Dados</button>
            </div>

            <div id="admin-module" class="admin-section hidden">
                <h3>ðŸ›  Painel de Controle (Admin)</h3>
                <div class="input-group">
                    <input type="text" id="new-user-name" placeholder="Nome do usuÃ¡rio">
                    <select id="new-user-role">
                        <option value="user">Operador (User)</option>
                        <option value="admin">Administrador</option>
                    </select>
                    <button class="btn-admin" onclick="cadastrarUsuario()">âž• Salvar UsuÃ¡rio</button>
                </div>

                <h4>Lista de Acessos</h4>
                <table id="user-table">
                    <thead>
                        <tr><th>UsuÃ¡rio</th><th>Perfil</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <button class="btn-danger" onclick="logout()">Sair</button>
        </div>
    </div>

    <script>
        // AQUI ESTÃ O SEU LINK DO RENDER ATUALIZADO
        const API_URL = "https://app-dielectric.onrender.com";

        async function tentarLogin() {
            const user = document.getElementById('user-input').value;
            const pass = document.getElementById('pass-input').value;
            const status = document.getElementById('msg-status');

            status.classList.remove('hidden');
            status.innerText = "Validando acesso no servidor...";

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user, pass })
                });

                const dados = await response.json();

                if (dados.sucesso) {
                    abrirApp(user, dados.cargo === 'admin');
                } else {
                    alert(dados.mensagem || "Erro ao fazer login.");
                }
            } catch (err) {
                alert("O servidor demorou a responder. Como Ã© uma conta gratuita, o primeiro acesso do dia pode levar 30 segundos.");
            } finally {
                status.classList.add('hidden');
            }
        }

        function abrirApp(nome, isAdmin) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('welcome-text').innerText = "OlÃ¡, " + nome;

            if (isAdmin) {
                document.getElementById('admin-module').classList.remove('hidden');
                atualizarTabela();
            }
        }

        async function cadastrarUsuario() {
            const nome = document.getElementById('new-user-name').value;
            const cargo = document.getElementById('new-user-role').value;
            const senha = "123";

            if (!nome) return alert("Preencha o nome!");

            try {
                await fetch(`${API_URL}/usuarios`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome, senha, cargo })
                });
                alert("UsuÃ¡rio cadastrado!");
                document.getElementById('new-user-name').value = "";
                atualizarTabela();
            } catch (err) {
                alert("Erro ao cadastrar.");
            }
        }

        async function atualizarTabela() {
            try {
                const response = await fetch(`${API_URL}/usuarios`);
                const lista = await response.json();
                const corpoTabela = document.querySelector('#user-table tbody');
                corpoTabela.innerHTML = "";
                lista.forEach(u => {
                    const linha = corpoTabela.insertRow();
                    linha.innerHTML = `<td>${u.nome}</td><td><b>${u.cargo.toUpperCase()}</b></td>`;
                });
            } catch (err) {}
        }

        function logout() { location.reload(); }
    </script>
</body>
</html>
